<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Asha's Meds" />
  <title>Asha's Meds</title>
  <link rel="apple-touch-icon" href="asha-icon.png">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #FAF7F2; --warm-white: #FFF9F3; --blush: #E8D5C4;
      --dusty-rose: #C9A99A; --terracotta: #B5705A; --deep: #3D2B1F;
      --mid: #7A5C50; --light-mid: #A88070; --success: #7A9E7E; --error: #C05A4A;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; background: var(--cream); font-family: "DM Sans", sans-serif; color: var(--deep); overscroll-behavior: none; }
    body {
      min-height: 100dvh; display: flex; flex-direction: column; align-items: center;
      padding: env(safe-area-inset-top, 20px) 0 env(safe-area-inset-bottom, 20px);
    }
    body::before, body::after {
      content: ""; position: fixed; border-radius: 50%; pointer-events: none; z-index: 0;
    }
    body::before { top: -30%; right: -20%; width: 60vw; height: 60vw; background: radial-gradient(circle, #E8D5C4, transparent 70%); opacity: .5; }
    body::after  { bottom: -20%; left: -15%; width: 50vw; height: 50vw; background: radial-gradient(circle, #C9A99A, transparent 70%); opacity: .25; }

    .app { position: relative; z-index: 1; width: 100%; max-width: 420px; padding: 40px 20px 0; display: flex; flex-direction: column; gap: 20px; }

    .header { text-align: center; }
    .cat-photo {
      width: 110px; height: 110px; border-radius: 50%; object-fit: cover;
      display: block; margin: 0 auto 12px;
      box-shadow: 0 6px 24px rgba(61,43,31,.22), 0 0 0 4px var(--blush);
      animation: float 4s ease-in-out infinite;
    }
    @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    h1 { font-family: Helvetica, Arial, sans-serif; font-size: 30px; font-weight: normal; color: var(--deep); letter-spacing: .5px; }
    .header p { font-size: 13px; color: var(--mid); font-weight: 300; margin-top: 4px; letter-spacing: .3px; }

    .card {
      background: var(--warm-white); border-radius: 24px; padding: 24px;
      box-shadow: 0 4px 24px rgba(61,43,31,.12), 0 1px 4px rgba(61,43,31,.06);
      border: 1px solid rgba(232,213,196,.6);
      display: flex; flex-direction: column; gap: 16px;
    }
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: .8px; color: var(--light-mid); }
    label small { font-size: 10px; color: var(--blush); text-transform: none; letter-spacing: 0; font-weight: 400; }

    input, select {
      width: 100%; background: var(--cream); border: 1.5px solid var(--blush);
      border-radius: 12px; padding: 12px 14px;
      font-family: "DM Sans", sans-serif; font-size: 15px; color: var(--deep);
      outline: none; -webkit-appearance: none; appearance: none;
      transition: border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus { border-color: var(--terracotta); box-shadow: 0 0 0 3px rgba(181,112,90,.12); }
    .sel { position: relative; }
    .sel::after { content: "⌄"; position: absolute; right: 14px; top: 50%; transform: translateY(-52%); color: var(--dusty-rose); font-size: 18px; pointer-events: none; }

    .time-row { display: grid; grid-template-columns: 1fr 1fr 80px; gap: 10px; }
    .divider { height: 1px; background: linear-gradient(to right, transparent, var(--blush), transparent); }

    .who-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .who-btn {
      background: var(--cream); border: 1.5px solid var(--blush); border-radius: 12px;
      padding: 12px; font-family: "DM Sans", sans-serif; font-size: 14px; font-weight: 500;
      color: var(--mid); cursor: pointer; transition: all .15s; text-align: center;
    }
    .who-btn.active { background: var(--terracotta); border-color: var(--terracotta); color: white; }
    .who-btn:active { transform: scale(.97); }

    .submit-btn {
      width: 100%; background: var(--terracotta); color: white; border: none;
      border-radius: 16px; padding: 16px; font-family: "DM Sans", sans-serif;
      font-size: 16px; font-weight: 500; cursor: pointer; letter-spacing: .2px;
      box-shadow: 0 4px 16px rgba(181,112,90,.35); transition: all .2s;
    }
    .submit-btn:active { transform: scale(.98); }
    .submit-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }
    .spinner { display: none; width: 20px; height: 20px; border: 2.5px solid rgba(255,255,255,.4); border-top-color: white; border-radius: 50%; animation: spin .7s linear infinite; margin: 0 auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading .btn-text { display: none; }
    .loading .spinner { display: block; }

    .log-header { font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: .8px; color: var(--light-mid); margin-bottom: 10px; }
    .log-item {
      background: var(--warm-white); border-radius: 14px; padding: 12px 16px;
      display: flex; justify-content: space-between; align-items: center;
      border: 1px solid rgba(232,213,196,.5); animation: slideIn .3s ease;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .log-med { font-size: 14px; font-weight: 500; }
    .log-meta { font-size: 12px; color: var(--mid); font-weight: 300; margin-top: 2px; }
    .log-time { font-size: 13px; color: var(--dusty-rose); font-weight: 500; text-align: right; }
    .log-date { font-size: 11px; color: var(--light-mid); font-weight: 300; text-align: right; margin-top: 2px; }

    .config-note {
      text-align: center; font-size: 12px; color: var(--dusty-rose);
      background: rgba(201,169,154,.15); border-radius: 12px; padding: 10px 16px;
      border: 1px solid rgba(201,169,154,.3);
    }
    .config-note a { color: var(--terracotta); }

    .toast {
      position: fixed; bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
      left: 50%; transform: translateX(-50%) translateY(80px);
      background: var(--deep); color: white; padding: 12px 22px; border-radius: 100px;
      font-size: 14px; white-space: nowrap; z-index: 100; opacity: 0;
      transition: transform .35s cubic-bezier(.34,1.56,.64,1), opacity .35s;
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }
  </style>
</head>
<body>
<div class="app">

  <div class="header">
    <img src="asha-icon.png" class="cat-photo" alt="Asha">
    <h1>Asha's Meds</h1>
    <p>Medication tracker</p>
  </div>

  <div class="config-note" id="configNote" style="display:none;">
    ⚠️ Google Sheet not connected. <a href="#" onclick="promptConfig()">Tap to add your URL.</a>
  </div>

  <div class="card">
    <div class="field">
      <label>Date</label>
      <input type="date" id="dateInput" />
    </div>

    <div class="field">
      <label>Time</label>
      <div class="time-row">
        <div class="sel"><select id="hourSelect"></select></div>
        <div class="sel"><select id="minuteSelect"></select></div>
        <div class="sel"><select id="ampmSelect"><option>AM</option><option>PM</option></select></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="field">
      <label>Medication</label>
      <div class="sel"><select id="medSelect"></select></div>
    </div>

    <div class="field">
      <label>Dose <small>(e.g. 5mg, 2 drops)</small></label>
      <input type="text" id="doseInput" placeholder="e.g. 5mg" />
    </div>

    <div class="divider"></div>

    <div class="field">
      <label>Given by</label>
      <div class="who-row" id="whoRow"></div>
    </div>

    <div class="field">
      <label>Notes <small>(optional)</small></label>
      <input type="text" id="notesInput" placeholder="e.g. ate well beforehand" />
    </div>
  </div>

  <button class="submit-btn" id="submitBtn" onclick="submitLog()">
    <span class="btn-text">Log Medication ✓</span>
    <div class="spinner"></div>
  </button>

  <div>
    <div class="log-header">Recent Entries</div>
    <div id="logList"><p style="font-size:13px;color:var(--light-mid);text-align:center;padding:12px 0;">No entries yet this session</p></div>
  </div>

</div>
<div class="toast" id="toast"></div>

<script>
  // ── CONFIG ─────────────────────────────────────────────────────────
  const SCRIPT_URL = localStorage.getItem("ashaScriptUrl") || "https://script.google.com/macros/s/AKfycby1wigGNWAp0dWngPnsFTG04gx8s6d6iowBxLSNDhDU3qlhfDSfv9xJj7ovYJxjxzE/exec";

  const MEDS = [
    { name: "Famotidine",     dose: "5mg" },
    { name: "Ear Drops",      dose: "" },
    { name: "RevolutionPlus", dose: "" },
    { name: "Cerenia", dose: "8mg"},
    // Add more: { name: "MedName", dose: "Xmg" },
  ];

  const NAMES = ["Cyneé", "Stephen", "Other"];
  // ──────────────────────────────────────────────────────────────────

  let selectedWho = NAMES[0];
  let sessionLog  = [];
  let sheetEntries = [];

  // ── INIT ───────────────────────────────────────────────────────────
  document.addEventListener("DOMContentLoaded", () => {
    setDateTime();
    buildMeds();
    buildWhoButtons();
    if (!SCRIPT_URL) document.getElementById("configNote").style.display = "block";
    fetchRecentEntries();
  });

  function setDateTime() {
    const now = new Date();
    // Local date (toISOString is UTC and can be off by a day)
    const y = now.getFullYear(), mo = now.getMonth()+1, d = now.getDate();
    document.getElementById("dateInput").value = `${y}-${String(mo).padStart(2,"0")}-${String(d).padStart(2,"0")}`;

    const hourSel = document.getElementById("hourSelect");
    const minSel  = document.getElementById("minuteSelect");
    hourSel.innerHTML = "";
    minSel.innerHTML  = "";
    for (let h = 1; h <= 12; h++) hourSel.innerHTML += `<option>${h}</option>`;
    for (let m = 0; m < 60; m++)  minSel.innerHTML  += `<option value="${m}">${String(m).padStart(2,"0")}</option>`;

    let h = now.getHours();
    document.getElementById("ampmSelect").value  = h >= 12 ? "PM" : "AM";
    document.getElementById("hourSelect").value  = h % 12 || 12;
    document.getElementById("minuteSelect").value = now.getMinutes();
  }

  function resetTime() {
    const now = new Date();
    let h = now.getHours();
    document.getElementById("ampmSelect").value   = h >= 12 ? "PM" : "AM";
    document.getElementById("hourSelect").value   = h % 12 || 12;
    document.getElementById("minuteSelect").value = now.getMinutes();
  }

  function buildMeds() {
    const sel = document.getElementById("medSelect");
    sel.innerHTML = MEDS.map(m => `<option value="${m.name}">${m.name}</option>`).join("");
    sel.value = MEDS[0].name;
    document.getElementById("doseInput").value = MEDS[0].dose;
    sel.addEventListener("change", () => {
      const med = MEDS.find(m => m.name === sel.value);
      document.getElementById("doseInput").value = med ? med.dose : "";
    });
  }

  function buildWhoButtons() {
    document.getElementById("whoRow").innerHTML = NAMES.map((name, i) =>
      `<button class="who-btn${i===0?" active":""}" onclick="selectWho(this)">${name}</button>`
    ).join("");
  }

  function selectWho(btn) {
    document.querySelectorAll(".who-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedWho = btn.textContent;
  }

  // ── TIME HELPERS ───────────────────────────────────────────────────
  function get24hr() {
    let h = +document.getElementById("hourSelect").value;
    const m = +document.getElementById("minuteSelect").value;
    const ap = document.getElementById("ampmSelect").value;
    if (ap === "PM" && h !== 12) h += 12;
    if (ap === "AM" && h === 12) h = 0;
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }

  function get12hr() {
    const h = document.getElementById("hourSelect").value;
    const m = String(document.getElementById("minuteSelect").value).padStart(2,"0");
    return `${h}:${m} ${document.getElementById("ampmSelect").value}`;
  }

  // ── SUBMIT ─────────────────────────────────────────────────────────
  async function submitLog() {
    const url  = localStorage.getItem("ashaScriptUrl") || SCRIPT_URL;
    if (!url) { toast("⚠️ No Google Sheet connected!", "error"); return; }

    const date = document.getElementById("dateInput").value;
    const dose = document.getElementById("doseInput").value.trim();
    if (!date || !dose) { toast("Please fill in all fields", "error"); return; }

    const btn = document.getElementById("submitBtn");
    btn.classList.add("loading"); btn.disabled = true;

    try {
      await fetch(url, {
        method: "POST", mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          date, time: get24hr(), medication: document.getElementById("medSelect").value,
          dose, givenBy: selectedWho,
          notes: document.getElementById("notesInput").value.trim(),
          timestamp: new Date().toISOString()
        })
      });
      toast("✓ Logged!", "success");
      addToLog(date, get12hr(), document.getElementById("medSelect").value, dose, selectedWho);
      document.getElementById("notesInput").value = "";
      resetTime();
      setTimeout(fetchRecentEntries, 1500);
    } catch(e) {
      toast("❌ Failed. Check connection.", "error");
    }

    btn.classList.remove("loading"); btn.disabled = false;
  }

  // ── SESSION LOG ────────────────────────────────────────────────────
  function addToLog(date, time, med, dose, who) {
    sessionLog.unshift({ date, time, med, dose, who });
    renderLog();
  }

  function renderLog() {
    // Show session entries first, then fill up to 3 with sheet entries (deduplicated by showing sheet only if no session entries exist or pad)
    const combined = sessionLog.length > 0 ? sessionLog.slice(0, 3) : sheetEntries.slice(0, 3);
    if (combined.length === 0) {
      document.getElementById("logList").innerHTML = `<p style="font-size:13px;color:var(--light-mid);text-align:center;padding:12px 0;">No entries yet</p>`;
      return;
    }
    document.getElementById("logList").innerHTML = combined.map(e => `
      <div class="log-item">
        <div><div class="log-med">${e.med} · ${e.dose}</div><div class="log-meta">Given by ${e.who}</div></div>
        <div><div class="log-time">${e.time}</div><div class="log-date">${e.date}</div></div>
      </div>`).join("");
  }

  // ── FETCH RECENT FROM SHEET ────────────────────────────────────────
  async function fetchRecentEntries() {
    const url = localStorage.getItem("ashaScriptUrl") || SCRIPT_URL;
    if (!url) return;
    try {
      const res = await fetch(url + "?action=getRecent&n=3");
      if (!res.ok) return;
      const data = await res.json();
      if (Array.isArray(data)) {
        sheetEntries = data.map(r => ({
          date: r.date || "",
          time: r.time || "",
          med:  r.medication || "",
          dose: r.dose || "",
          who:  r.givenBy || ""
        }));
        if (sessionLog.length === 0) renderLog();
      }
    } catch(e) {
      // silently fail — sheet fetch is best-effort
    }
  }

  // ── TOAST ──────────────────────────────────────────────────────────
  function toast(msg, type="") {
    const t = document.getElementById("toast");
    t.textContent = msg; t.className = "toast " + type;
    void t.offsetWidth;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
  }

  // ── URL CONFIG ─────────────────────────────────────────────────────
  function promptConfig() {
    const url = prompt("Paste your Google Apps Script Web App URL:");
    if (url?.startsWith("https://")) { localStorage.setItem("ashaScriptUrl", url); location.reload(); }
  }
</script>
</body>
</html>

